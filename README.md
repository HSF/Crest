#### Author: A.Formica, R.Sipos
##### Date of last development period: 2017/10/01 
```
   Copyright (C) 2016  A.Formica, R.Sipos

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
```
# Table of Contents
1. [Description](#description)
2. [Installation](#installation)
3. [Build instructions](#build-instructions)
4. [Run the server](#run-the-server)
5. [Swagger](#swagger)
6. [Docker](#docker)
7. [Openshift](#openshift)

## Description
Test project for the implementation of a generic purpose conditions database for physics experiment.
This server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project. By using the 
[OpenAPI-Spec](https://github.com/swagger-api/swagger-core/wiki) from a remote server, you can easily generate a server stub.  This
project is an example of building a swagger-enabled JAX-RS server. Some tests were also done to provide a Resteasy implementation.

The prototype uses [Spring framework](https://spring.io) and the REST services are implemented via  [Jersey](https://jersey.java.net).

The prototype runs as a microservice using `spring-boot`. By default it uses an embedded [undertow](http://undertow.io) servlet container, but others like [tomcat](https://tomcat.apache.org) or [jetty](https://www.eclipse.org/jetty/) can be easily used instead of [undertow](http://undertow.io).


## Installation
Download the project from gitlab (example below is using `https`):
```
git clone https://gitlab.cern.ch/formica/swagger_crestdb.git
```
This will create a directory `swagger_crestdb` in the location where you run the git command.

## Build instructions
You need to have java >= 8 installed on your machine. If you have also [gradle](https://gradle.org) (version 5) you can build the project using the following command from the root project directory (`swagger_crestdb`):
```
gradle clean :crestdb-web:build -PwarName=crest.war
```
This command will generate a war (java web archive) file in  : `crestdb-web/build/libs/crest.war`.
In case gradle is not installed on your machine, you can run the wrapper delivered with the project:
```
./gradlew clean :crestdb-web:build -PwarName=crest.war
```

## Run the server
This section is under maintenance.

To run the server, you can either start an embedded tomcat (or undertow) web server via spring boot, or deploy the generated war file in an existing tomcat instance. The embedded server type is specified in the `crest-filter-values.properties` file:
```
server=undertow
jaxrs=jersey
```
or
```
server=tomcat
jaxrs=jersey
```

The server need by definition to have a database connection in order to store the conditions data. The database connections are defined in the file `./crestdb-web/src/main/resources/application.yml`. This file present different set of properties which are chosen by selecting a specific spring profile when running the server. The file should be edited if you are administering the conditions database in order to provide an appropriate set of parameters.

If you do not have any remote database available you should use the default spring profile

We provide the following commands as examples:
```
cd crestdb-web
$ gradle bootRun "-Dspring.profiles.active=prod" "-Dcrest.db.password=xxx"
```
or
```
$java -Dspring.profiles.active=prod -Dcrest.db.password=xxx -jar crestdb-web/build/libs/crest.war
```

For faster start and stop of the service we provide also a script that can be used.
```
./crestrun.sh start dbfilename
```
and
```
./crestrun.sh stop
```
For the moment the script is not very well documented, but it should be easy to configure it at your needs.


## Swagger
You can then view the swagger listing here (hopefully the server will be up!):

```
http://crest-undertow.web.cern.ch/crestapi/swagger.json
```
and if you want to play with the server using the swagger-ui you can access it here:

```
http://crest-undertow.web.cern.ch/ext/web/ui/index.html
```

Note that in principle you can get the same links working (a part from the hostname) if you run the server locally.

## Docker
You can build a container using
```
docker build -t crest:1.0 .
```
You can run the container using
```
docker run --env-file .environment -p 8080:8080 -d crest:1.0
```
or
```
docker run --env-file .environment -p 8080:8080 -v /mnt/data/dump:/data/dump -v /mnt/data/web:/data/web --net=host -d crest:test
```
In the last example we have been mounting external volumes. These are useful for the swagger-ui and the possibility to dump a tag in a file system based structure. You can use the swagger-ui version that is provided within this project in the directory
```
./web/ui/
```
A special note about the file `.environment` . You need to have this file to set variables which are used at the startup of the server. Some of the variables are already provided in the version in git, but other are not. For example, to access Oracle at CERN (for the moment only integration cluster contains a crest schema) you need to have the variable `crest.db.password=xxxxx` correctly set for a writer account. 
If you use `spring.profiles.active=default` you will have an h2 database created in `jdbc:h2:/tmp/cresth2;DB_CLOSE_ON_EXIT=FALSE`.

## Openshift
We gather here some notes on openshift deployment via gitlab-ci. These notes are for usage inside CERN.
### Constraints
For the moment in order for the deployment to work we need to have a public access to the gitlab project.
### Problems
After committing a tag it seems that the deploy to openshift fails.
TO BE DONE.