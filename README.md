#### Author: A.Formica, R.Sipos
##### Date of last development period: 2017/10/01 
```
   Copyright (C) 2016  A.Formica, R.Sipos

    This program is free software: you can redistribute it and/or modify
    it under the terms of the GNU General Public License as published by
    the Free Software Foundation, either version 3 of the License, or
    (at your option) any later version.

    This program is distributed in the hope that it will be useful,
    but WITHOUT ANY WARRANTY; without even the implied warranty of
    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
    GNU General Public License for more details.

    You should have received a copy of the GNU General Public License
    along with this program.  If not, see <http://www.gnu.org/licenses/>.
```
# Table of Contents
1. [Description](#description)
2. [Installation](#installation)
3. [Build instructions](#build-instructions)
4. [Run the server](#run-the-server)
5. [Swagger](#swagger)
6. [Docker](#docker)

## Description
Test project for the implementation of a generic purpose conditions database for physics experiment.
This server was generated by the [swagger-codegen](https://github.com/swagger-api/swagger-codegen) project. By using the 
[OpenAPI-Spec](https://github.com/swagger-api/swagger-core/wiki) from a remote server, you can easily generate a server stub.  This
is an example of building a swagger-enabled JAX-RS server. Some tests were also done to provide a Resteasy implementation.

The prototype uses [Spring framework](https://spring.io) and the REST services are implemented via  [Jersey](https://jersey.java.net).

## Installation
Download the project from gitlab (example below is using https):
```
git clone https://gitlab.cern.ch/formica/swagger_crestdb.git
```
This will create a directory `swagger_crestdb` in the location where you run the git command.

## Build instructions
You need to have java >= 8 installed on your machine. If you have also [gradle](https://gradle.org) (version 5) you can build the project using the following command from the root project directory (`swagger_crestdb`):
```
gradle clean :crestdb-web:build -PwarName=crest.war
```
This command will generate a war (java web archive) file in  : `crestdb-web/build/libs/crest.war`.
In case gradle is not installed on your machine, you can run the wrapper delivered with the project:
```
./gradlew clean :crestdb-web:build -PwarName=crest.war
```

## Run the server
This section is under maintenance.

To run the server, you can either start an embedded tomcat (or undertow) web server via spring boot, or deploy the generated war file in an existing tomcat instance. The embedded server type is specified in the `crest-filter-values.properties` file:
```
server=undertow
jaxrs=jersey
```
or
```
server=tomcat
jaxrs=jersey
```

The server need by definition to have a database connection in order to store the conditions data. The database connections are defined in the file `./crestdb-web/src/main/resources/application.yml`. This file present different set of properties which are chosen by selecting a specific spring profile when running the server. The file should be edited if you are administering the conditions database in order to provide an appropriate set of parameters.

If you do not have any remote database available you should use the default spring profile

We provide the following commands as examples:
```
cd crestdb-web
$ gradle bootRun "-Dspring.profiles.active=prod" "-Dcrest.db.password=xxx"
```
or
```
$java -Dspring.profiles.active=prod -Dcrest.db.password=xxx -jar crestdb-web/build/libs/crest.war
```



## Swagger
You can then view the swagger listing here:

```
http://localhost:8080/crestapi/swagger.json
```

Note that if you have configured the `host` to be something other than localhost, the calls through
swagger-ui will be directed to that host and not localhost!

## Docker
You can build a container using
```
docker build -t crest:1.0 .
```
You can run the container using
```
docker run --env-file .environment -p 8080:8080 -d crest:1.0
```
